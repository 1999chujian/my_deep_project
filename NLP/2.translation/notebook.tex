
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{attention}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \section{nmt}\label{nmt}

参考nmt模型搭建一个seq2seq的翻译系统，和之前seq2seq的区别在于加入attention，并且采用了更快的训练方法。

\begin{figure}
\centering
\includegraphics{attachment:seq2seq.jpg}
\caption{seq2seq.jpg}
\end{figure}

\subsection{数据处理}\label{ux6570ux636eux5904ux7406}

At the bottom layer, the encoder and decoder RNNs receive as input the
following: first, the source sentence, then a boundary marker "" which
indicates the transition from the encoding to the decoding mode, and the
target sentence. For training, we will feed the system with the
following tensors, which are in time-major format and contain word
indices:

\begin{itemize}
\tightlist
\item
  encoder\_inputs {[}max\_encoder\_time, batch\_size{]}: source input
  words.
\item
  decoder\_inputs {[}max\_decoder\_time, batch\_size{]}: target input
  words.
\item
  decoder\_outputs {[}max\_decoder\_time, batch\_size{]}: target output
  words, these are decoder\_inputs shifted to the left by one time step
  with an end-of-sentence tag appended on the right.
\end{itemize}

Here for efficiency, we train with multiple sentences (batch\_size) at
once. Testing is slightly different, so we will discuss it later.

我们按照{[}max\_encoder\_time,
batch\_size{]}的格式将每一个batch的数据进行处理。

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}1}]:} \PY{c+c1}{\PYZsh{} ========读取原始数据========}
        \PY{k}{with} \PY{n+nb}{open}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{cmn.txt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{encoding}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{utf\PYZhy{}8}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{k}{as} \PY{n}{f}\PY{p}{:}
            \PY{n}{data} \PY{o}{=} \PY{n}{f}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}
        \PY{n}{data} \PY{o}{=} \PY{n}{data}\PY{o}{.}\PY{n}{split}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{data} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{100}\PY{p}{]}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{data}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{5}\PY{p}{:}\PY{p}{]}\PY{p}{)}
        
        
        \PY{c+c1}{\PYZsh{} 分割英文数据和中文数据}
        \PY{n}{en\PYZus{}data} \PY{o}{=} \PY{p}{[}\PY{n}{line}\PY{o}{.}\PY{n}{split}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+se}{\PYZbs{}t}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{data}\PY{p}{]}
        \PY{n}{ch\PYZus{}data} \PY{o}{=} \PY{p}{[}\PY{n}{line}\PY{o}{.}\PY{n}{split}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+se}{\PYZbs{}t}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{data}\PY{p}{]}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{英文数据:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{en\PYZus{}data}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{10}\PY{p}{]}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{中文数据:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{ch\PYZus{}data}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{10}\PY{p}{]}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
['Tom died.\textbackslash{}t汤姆去世了。', 'Tom quit.\textbackslash{}t汤姆不干了。', 'Tom swam.\textbackslash{}t汤姆游泳了。', 'Trust me.\textbackslash{}t相信我。', 'Try hard.\textbackslash{}t努力。']
英文数据:
 ['Hi.', 'Hi.', 'Run.', 'Wait!', 'Hello!', 'I try.', 'I won!', 'Oh no!', 'Cheers!', 'He ran.']

中文数据:
 ['嗨。', '你好。', '你用跑的。', '等等！', '你好。', '让我来。', '我赢了。', '不会吧。', '乾杯!', '他跑了。']

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{c+c1}{\PYZsh{} 特殊字符}
        \PY{n}{SOURCE\PYZus{}CODES} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}PAD\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}UNK\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        \PY{n}{TARGET\PYZus{}CODES} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}PAD\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}EOS\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}UNK\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}GO\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}  \PY{c+c1}{\PYZsh{} 在target中，需要增加\PYZlt{}GO\PYZgt{}与\PYZlt{}EOS\PYZgt{}特殊字符}
        
        \PY{c+c1}{\PYZsh{} 分别生成中英文字典}
        \PY{n}{en\PYZus{}vocab} \PY{o}{=} \PY{n+nb}{set}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{n}{en\PYZus{}data}\PY{p}{)}\PY{p}{)}
        \PY{n}{id2en} \PY{o}{=} \PY{n}{SOURCE\PYZus{}CODES} \PY{o}{+} \PY{n+nb}{list}\PY{p}{(}\PY{n}{en\PYZus{}vocab}\PY{p}{)}
        \PY{n}{en2id} \PY{o}{=} \PY{p}{\PYZob{}}\PY{n}{c}\PY{p}{:}\PY{n}{i} \PY{k}{for} \PY{n}{i}\PY{p}{,}\PY{n}{c} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{id2en}\PY{p}{)}\PY{p}{\PYZcb{}}
        
        \PY{c+c1}{\PYZsh{} 分别生成中英文字典}
        \PY{n}{ch\PYZus{}vocab} \PY{o}{=} \PY{n+nb}{set}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{n}{ch\PYZus{}data}\PY{p}{)}\PY{p}{)}
        \PY{n}{id2ch} \PY{o}{=} \PY{n}{TARGET\PYZus{}CODES} \PY{o}{+} \PY{n+nb}{list}\PY{p}{(}\PY{n}{ch\PYZus{}vocab}\PY{p}{)}
        \PY{n}{ch2id} \PY{o}{=} \PY{p}{\PYZob{}}\PY{n}{c}\PY{p}{:}\PY{n}{i} \PY{k}{for} \PY{n}{i}\PY{p}{,}\PY{n}{c} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{id2ch}\PY{p}{)}\PY{p}{\PYZcb{}}
        
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{英文字典:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{en2id}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{中文字典共计}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{ch2id}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]

英文字典:
 \{'<PAD>': 0, '<UNK>': 1, 'I': 2, 'J': 3, 'B': 4, 'P': 5, 'k': 6, 'p': 7, 'T': 8, 'L': 9, ' ': 10, 'A': 11, 'l': 12, 'w': 13, 'b': 14, 'W': 15, 'O': 16, 'u': 17, 'm': 18, 'Y': 19, 'q': 20, 'i': 21, 'n': 22, '?': 23, 'e': 24, 'R': 25, 'a': 26, 'c': 27, 'K': 28, 'G': 29, 'H': 30, 'C': 31, 't': 32, '!': 33, 's': 34, 'y': 35, 'N': 36, 'h': 37, 'o': 38, 'r': 39, 'S': 40, 'f': 41, 'D': 42, 'g': 43, '.': 44, 'v': 45, "'": 46, 'd': 47\}

中文字典共计
: \{'<PAD>': 0, '<EOS>': 1, '<UNK>': 2, '<GO>': 3, '帮': 4, '铐': 5, '了': 6, '可': 7, '管': 8, '友': 9, '定': 10, '试': 11, '忙': 12, '好': 13, '玩': 14, '很': 15, '赢': 16, '忘': 17, '事': 18, '干': 19, '抓': 20, '确': 21, '的': 22, '。': 23, '醒': 24, '欢': 25, '持': 26, '她': 27, '人': 28, '汤': 29, '世': 30, '点': 31, '得': 32, '把': 33, '付': 34, '着': 35, '系': 36, '来': 37, '我': 38, '生': 39, '再': 40, '公': 41, '出': 42, '!': 43, '們': 44, '用': 45, '坚': 46, '清': 47, '前': 48, '他': 49, '到': 50, '弃': 51, '老': 52, '心': 53, '联': 54, '入': 55, '同': 56, '相': 57, '往': 58, '吧': 59, '意': 60, '能': 61, '别': 62, '趕': 63, '趴': 64, '会': 65, '，': 66, '信': 67, '找': 68, '为': 69, '滾': 70, '谁': 71, '始': 72, '跳': 73, '它': 74, '么': 75, '没': 76, '姆': 77, '跑': 78, '嗨': 79, '门': 80, '病': 81, '完': 82, '随': 83, '？': 84, '閉': 85, '善': 86, '走': 87, '上': 88, '錢': 89, '开': 90, '后': 91, '加': 92, '飽': 93, '來': 94, '拿': 95, '静': 96, '当': 97, '退': 98, '迎': 99, '努': 100, '让': 101, '什': 102, '抱': 103, '听': 104, '知': 105, '起': 106, '快': 107, '问': 108, '和': 109, '！': 110, '游': 111, '泳': 112, '辞': 113, '个': 114, '关': 115, '道': 116, '開': 117, '去': 118, '气': 119, '进': 120, '们': 121, '平': 122, '告': 123, '一': 124, '力': 125, '等': 126, '洗': 127, '吃': 128, '嘴': 129, '留': 130, '杯': 131, '动': 132, '沒': 133, '美': 134, '不': 135, '下': 136, '见': 137, '呆': 138, '立': 139, '吻': 140, '儿': 141, '乾': 142, '是': 143, '冷': 144, '住': 145, '失': 146, '就': 147, '放': 148, '你': 149, '迷': 150\}

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{c+c1}{\PYZsh{} 利用字典，映射数据}
        \PY{n}{en\PYZus{}num\PYZus{}data} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{en2id}\PY{p}{[}\PY{n}{en}\PY{p}{]} \PY{k}{for} \PY{n}{en} \PY{o+ow}{in} \PY{n}{line}\PY{p}{]} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{en\PYZus{}data}\PY{p}{]}
        \PY{n}{ch\PYZus{}num\PYZus{}data} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{ch2id}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}GO\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]} \PY{o}{+} \PY{p}{[}\PY{n}{ch2id}\PY{p}{[}\PY{n}{ch}\PY{p}{]} \PY{k}{for} \PY{n}{ch} \PY{o+ow}{in} \PY{n}{line}\PY{p}{]} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{ch\PYZus{}data}\PY{p}{]}
        \PY{n}{de\PYZus{}num\PYZus{}data} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{ch2id}\PY{p}{[}\PY{n}{ch}\PY{p}{]} \PY{k}{for} \PY{n}{ch} \PY{o+ow}{in} \PY{n}{line}\PY{p}{]} \PY{o}{+} \PY{p}{[}\PY{n}{ch2id}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}EOS\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{ch\PYZus{}data}\PY{p}{]}
        
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{char:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{en\PYZus{}data}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{en\PYZus{}num\PYZus{}data}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        
        
        \PY{c+c1}{\PYZsh{} 设计数据生成器}
        \PY{k}{def} \PY{n+nf}{batch\PYZus{}data}\PY{p}{(}\PY{n}{en\PYZus{}num\PYZus{}data}\PY{p}{,} \PY{n}{ch\PYZus{}num\PYZus{}data}\PY{p}{,} \PY{n}{de\PYZus{}num\PYZus{}data}\PY{p}{,} \PY{n}{batch\PYZus{}size}\PY{p}{)}\PY{p}{:}
            \PY{n}{batch\PYZus{}num} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{en\PYZus{}num\PYZus{}data}\PY{p}{)} \PY{o}{/}\PY{o}{/} \PY{n}{batch\PYZus{}size}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{batch\PYZus{}num}\PY{p}{)}\PY{p}{:}
                \PY{n}{begin} \PY{o}{=} \PY{n}{i} \PY{o}{*} \PY{n}{batch\PYZus{}size}
                \PY{n}{end} \PY{o}{=} \PY{n}{begin} \PY{o}{+} \PY{n}{batch\PYZus{}size}
                \PY{n}{encoder\PYZus{}inputs} \PY{o}{=} \PY{n}{en\PYZus{}num\PYZus{}data}\PY{p}{[}\PY{n}{begin}\PY{p}{:}\PY{n}{end}\PY{p}{]}
                \PY{n}{decoder\PYZus{}inputs} \PY{o}{=} \PY{n}{ch\PYZus{}num\PYZus{}data}\PY{p}{[}\PY{n}{begin}\PY{p}{:}\PY{n}{end}\PY{p}{]}
                \PY{n}{decoder\PYZus{}targets} \PY{o}{=} \PY{n}{de\PYZus{}num\PYZus{}data}\PY{p}{[}\PY{n}{begin}\PY{p}{:}\PY{n}{end}\PY{p}{]}
                \PY{n}{encoder\PYZus{}lengths} \PY{o}{=} \PY{p}{[}\PY{n+nb}{len}\PY{p}{(}\PY{n}{line}\PY{p}{)} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{encoder\PYZus{}inputs}\PY{p}{]}        
                \PY{n}{decoder\PYZus{}lengths} \PY{o}{=} \PY{p}{[}\PY{n+nb}{len}\PY{p}{(}\PY{n}{line}\PY{p}{)} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{decoder\PYZus{}inputs}\PY{p}{]}
                \PY{n}{encoder\PYZus{}max\PYZus{}length} \PY{o}{=} \PY{n+nb}{max}\PY{p}{(}\PY{n}{encoder\PYZus{}lengths}\PY{p}{)}
                \PY{n}{decoder\PYZus{}max\PYZus{}length} \PY{o}{=} \PY{n+nb}{max}\PY{p}{(}\PY{n}{decoder\PYZus{}lengths}\PY{p}{)}
                \PY{n}{encoder\PYZus{}inputs} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{data} \PY{o}{+} \PY{p}{[}\PY{n}{en2id}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}PAD\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]} \PY{o}{*} \PY{p}{(}\PY{n}{encoder\PYZus{}max\PYZus{}length} \PY{o}{\PYZhy{}} \PY{n+nb}{len}\PY{p}{(}\PY{n}{data}\PY{p}{)}\PY{p}{)} \PY{k}{for} \PY{n}{data} \PY{o+ow}{in} \PY{n}{encoder\PYZus{}inputs}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{T}
                \PY{n}{decoder\PYZus{}inputs} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{data} \PY{o}{+} \PY{p}{[}\PY{n}{ch2id}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}PAD\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]} \PY{o}{*} \PY{p}{(}\PY{n}{decoder\PYZus{}max\PYZus{}length} \PY{o}{\PYZhy{}} \PY{n+nb}{len}\PY{p}{(}\PY{n}{data}\PY{p}{)}\PY{p}{)} \PY{k}{for} \PY{n}{data} \PY{o+ow}{in} \PY{n}{decoder\PYZus{}inputs}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{T}
                \PY{n}{decoder\PYZus{}targets} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{data} \PY{o}{+} \PY{p}{[}\PY{n}{ch2id}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZlt{}PAD\PYZgt{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]} \PY{o}{*} \PY{p}{(}\PY{n}{decoder\PYZus{}max\PYZus{}length} \PY{o}{\PYZhy{}} \PY{n+nb}{len}\PY{p}{(}\PY{n}{data}\PY{p}{)}\PY{p}{)} \PY{k}{for} \PY{n}{data} \PY{o+ow}{in} \PY{n}{decoder\PYZus{}targets}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{T}
                \PY{n}{mask} \PY{o}{=} \PY{n}{decoder\PYZus{}targets} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}
                \PY{n}{target\PYZus{}weights} \PY{o}{=} \PY{n}{mask}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
                \PY{k}{yield} \PY{n}{encoder\PYZus{}inputs}\PY{p}{,} \PY{n}{decoder\PYZus{}inputs}\PY{p}{,} \PY{n}{decoder\PYZus{}targets}\PY{p}{,} \PY{n}{target\PYZus{}weights}\PY{p}{,} \PY{n}{encoder\PYZus{}lengths}\PY{p}{,} \PY{n}{decoder\PYZus{}lengths}
                      
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
char: Hi.
index: [30, 21, 44]

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{k+kn}{import} \PY{n+nn}{tensorflow} \PY{k}{as} \PY{n+nn}{tf}
        
        \PY{n}{keepprb} \PY{o}{=} \PY{l+m+mf}{0.9}
        
        \PY{n}{EN\PYZus{}VOCAB\PYZus{}SIZE} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{en2id}\PY{p}{)}
        \PY{n}{CH\PYZus{}VOCAB\PYZus{}SIZE} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ch2id}\PY{p}{)}
        
        \PY{n}{HIDDEN\PYZus{}LAYERS} \PY{o}{=} \PY{l+m+mi}{1}
        \PY{n}{HIDDEN\PYZus{}SIZE} \PY{o}{=} \PY{l+m+mi}{128}
        
        \PY{n}{learning\PYZus{}rate} \PY{o}{=} \PY{l+m+mf}{0.001}
        
        \PY{n}{BATCH\PYZus{}SIZE} \PY{o}{=} \PY{l+m+mi}{8}
        \PY{n}{BATCH\PYZus{}NUMS} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ch\PYZus{}num\PYZus{}data}\PY{p}{)} \PY{o}{/}\PY{o}{/} \PY{n}{BATCH\PYZus{}SIZE}
        \PY{n}{MAX\PYZus{}GRAD\PYZus{}NORM} \PY{o}{=} \PY{l+m+mi}{1}
        
        \PY{n}{EPOCHS} \PY{o}{=} \PY{l+m+mi}{50}
\end{Verbatim}


    \subsection{placeholder}\label{placeholder}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{n}{encoder\PYZus{}inputs} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{placeholder}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{int32}\PY{p}{,} \PY{p}{[}\PY{k+kc}{None}\PY{p}{,} \PY{n}{BATCH\PYZus{}SIZE}\PY{p}{]}\PY{p}{)}
        \PY{n}{decoder\PYZus{}inputs} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{placeholder}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{int32}\PY{p}{,} \PY{p}{[}\PY{k+kc}{None}\PY{p}{,} \PY{n}{BATCH\PYZus{}SIZE}\PY{p}{]}\PY{p}{)}
        \PY{n}{decoder\PYZus{}targets} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{placeholder}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{int32}\PY{p}{,} \PY{p}{[}\PY{k+kc}{None}\PY{p}{,} \PY{n}{BATCH\PYZus{}SIZE}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{target\PYZus{}weights} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{placeholder}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{float32}\PY{p}{,} \PY{p}{[}\PY{k+kc}{None}\PY{p}{,} \PY{n}{BATCH\PYZus{}SIZE}\PY{p}{]}\PY{p}{)}
        \PY{n}{source\PYZus{}sequence\PYZus{}length} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{placeholder}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{int32}\PY{p}{,} \PY{p}{[}\PY{n}{BATCH\PYZus{}SIZE}\PY{p}{,}\PY{p}{]}\PY{p}{)}
        \PY{n}{decoder\PYZus{}lengths} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{placeholder}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{int32}\PY{p}{,} \PY{p}{[}\PY{n}{BATCH\PYZus{}SIZE}\PY{p}{,}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{keepprb} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{placeholder}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
\end{Verbatim}


    \subsection{Embedding词嵌入层}\label{embeddingux8bcdux5d4cux5165ux5c42}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{c+c1}{\PYZsh{} encoder}
        \PY{k}{with} \PY{n}{tf}\PY{o}{.}\PY{n}{name\PYZus{}scope}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{embedding\PYZus{}encoder}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{:}
        	\PY{n}{encoder\PYZus{}embedding} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{get\PYZus{}variable}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{embedding\PYZus{}encoder}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{p}{[}\PY{n}{EN\PYZus{}VOCAB\PYZus{}SIZE}\PY{p}{,} \PY{n}{HIDDEN\PYZus{}SIZE}\PY{p}{]}\PY{p}{)}
        	\PY{n}{encoder\PYZus{}emb} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{nn}\PY{o}{.}\PY{n}{embedding\PYZus{}lookup}\PY{p}{(}\PY{n}{encoder\PYZus{}embedding}\PY{p}{,} \PY{n}{encoder\PYZus{}inputs}\PY{p}{)}
        	\PY{n}{encoder\PYZus{}emb} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{nn}\PY{o}{.}\PY{n}{dropout}\PY{p}{(}\PY{n}{encoder\PYZus{}emb}\PY{p}{,} \PY{n}{keepprb}\PY{p}{)}
        
            
        \PY{c+c1}{\PYZsh{} decoder}
        \PY{k}{with} \PY{n}{tf}\PY{o}{.}\PY{n}{name\PYZus{}scope}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{embedding\PYZus{}decoder}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{:}
        	\PY{n}{decoder\PYZus{}embedding} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{get\PYZus{}variable}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{embedding\PYZus{}decoder}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{p}{[}\PY{n}{CH\PYZus{}VOCAB\PYZus{}SIZE}\PY{p}{,} \PY{n}{HIDDEN\PYZus{}SIZE}\PY{p}{]}\PY{p}{)}
        	\PY{n}{decoder\PYZus{}emb} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{nn}\PY{o}{.}\PY{n}{embedding\PYZus{}lookup}\PY{p}{(}\PY{n}{decoder\PYZus{}embedding}\PY{p}{,} \PY{n}{decoder\PYZus{}inputs}\PY{p}{)}
        	\PY{n}{decoder\PYZus{}emb} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{nn}\PY{o}{.}\PY{n}{dropout}\PY{p}{(}\PY{n}{decoder\PYZus{}emb}\PY{p}{,} \PY{n}{keepprb}\PY{p}{)}
\end{Verbatim}


    \subsection{Encoder}\label{encoder}

Once retrieved, the word embeddings are then fed as input into the main
network, which consists of two multi-layer RNNs -- an encoder for the
source language and a decoder for the target language. These two RNNs,
in principle, can share the same weights; however, in practice, we often
use two different RNN parameters (such models do a better job when
fitting large training datasets). The encoder RNN uses zero vectors as
its starting states and is built as follows:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Build RNN cell}
\NormalTok{encoder_cell }\OperatorTok{=}\NormalTok{ tf.nn.rnn_cell.BasicLSTMCell(num_units)}

\CommentTok{# Run Dynamic RNN}
\CommentTok{#   encoder_outputs: [max_time, batch_size, num_units]}
\CommentTok{#   encoder_state: [batch_size, num_units]}
\NormalTok{encoder_outputs, encoder_state }\OperatorTok{=}\NormalTok{ tf.nn.dynamic_rnn(}
\NormalTok{    encoder_cell, encoder_emb_inp,}
\NormalTok{    sequence_length}\OperatorTok{=}\NormalTok{source_sequence_length, time_major}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Note that sentences have different lengths to avoid wasting computation,
we tell dynamic\_rnn the exact source sentence lengths through
source\_sequence\_length. Since our input is time major, we set
time\_major=True. Here, we build only a single layer LSTM,
encoder\_cell. We will describe how to build multi-layer LSTMs, add
dropout, and use attention in a later section.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{k}{def} \PY{n+nf}{create\PYZus{}rnn\PYZus{}cell}\PY{p}{(}\PY{n}{layer\PYZus{}num}\PY{o}{=}\PY{n}{HIDDEN\PYZus{}LAYERS}\PY{p}{)}\PY{p}{:}
            \PY{k}{def} \PY{n+nf}{single\PYZus{}rnn\PYZus{}cell}\PY{p}{(}\PY{p}{)}\PY{p}{:}
                \PY{n}{single\PYZus{}cell} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{rnn}\PY{o}{.}\PY{n}{LSTMCell}\PY{p}{(}\PY{n}{HIDDEN\PYZus{}SIZE}\PY{p}{)}
                \PY{c+c1}{\PYZsh{}添加dropout}
                \PY{n}{cell} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{rnn}\PY{o}{.}\PY{n}{DropoutWrapper}\PY{p}{(}\PY{n}{single\PYZus{}cell}\PY{p}{,} \PY{n}{output\PYZus{}keep\PYZus{}prob}\PY{o}{=}\PY{n}{keepprb}\PY{p}{)}
                \PY{k}{return} \PY{n}{cell}
            \PY{n}{cell} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{rnn}\PY{o}{.}\PY{n}{MultiRNNCell}\PY{p}{(}\PY{p}{[}\PY{n}{single\PYZus{}rnn\PYZus{}cell}\PY{p}{(}\PY{p}{)} \PY{k}{for} \PY{n}{\PYZus{}} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{layer\PYZus{}num}\PY{p}{)}\PY{p}{]}\PY{p}{)}
            \PY{k}{return} \PY{n}{cell}
        
        
        \PY{c+c1}{\PYZsh{} encoder}
        \PY{k}{with} \PY{n}{tf}\PY{o}{.}\PY{n}{variable\PYZus{}scope}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{encoder}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{:}
        	\PY{n}{encoder\PYZus{}cell} \PY{o}{=} \PY{n}{create\PYZus{}rnn\PYZus{}cell}\PY{p}{(}\PY{p}{)}
        	\PY{n}{initial\PYZus{}state} \PY{o}{=} \PY{n}{encoder\PYZus{}cell}\PY{o}{.}\PY{n}{zero\PYZus{}state}\PY{p}{(}\PY{n}{BATCH\PYZus{}SIZE}\PY{p}{,} \PY{n}{tf}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        	\PY{n}{encoder\PYZus{}outputs}\PY{p}{,} \PY{n}{final\PYZus{}state} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{nn}\PY{o}{.}\PY{n}{dynamic\PYZus{}rnn}\PY{p}{(}\PY{n}{encoder\PYZus{}cell}\PY{p}{,} \PY{n}{encoder\PYZus{}emb}\PY{p}{,} \PY{n}{sequence\PYZus{}length}\PY{o}{=}\PY{n}{source\PYZus{}sequence\PYZus{}length}\PY{p}{,} 
                                               \PY{n}{time\PYZus{}major}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{initial\PYZus{}state}\PY{o}{=}\PY{n}{initial\PYZus{}state}\PY{p}{)}
\end{Verbatim}


    \subsection{attention}\label{attention}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}8}]:} \PY{n}{memory} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{encoder\PYZus{}outputs}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Create an attention mechanism}
        \PY{n}{attention\PYZus{}mechanism} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{LuongAttention}\PY{p}{(}\PY{n}{HIDDEN\PYZus{}SIZE}\PY{p}{,} \PY{n}{memory}\PY{p}{,} \PY{n}{memory\PYZus{}sequence\PYZus{}length}\PY{o}{=}\PY{n}{source\PYZus{}sequence\PYZus{}length}\PY{p}{)}
\end{Verbatim}


    \subsection{Decoder}\label{decoder}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}9}]:} \PY{k+kn}{from} \PY{n+nn}{tensorflow}\PY{n+nn}{.}\PY{n+nn}{python}\PY{n+nn}{.}\PY{n+nn}{layers}\PY{n+nn}{.}\PY{n+nn}{core} \PY{k}{import} \PY{n}{Dense}
        
        \PY{c+c1}{\PYZsh{} decoder cell}
        \PY{k}{with} \PY{n}{tf}\PY{o}{.}\PY{n}{variable\PYZus{}scope}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{decoder\PYZus{}cell}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{:}
            \PY{n}{decoder\PYZus{}cell} \PY{o}{=} \PY{n}{create\PYZus{}rnn\PYZus{}cell}\PY{p}{(}\PY{p}{)}
            \PY{n}{decoder\PYZus{}cell} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{AttentionWrapper}\PY{p}{(}\PY{n}{decoder\PYZus{}cell}\PY{p}{,} \PY{n}{attention\PYZus{}mechanism}\PY{p}{,} \PY{n}{attention\PYZus{}layer\PYZus{}size}\PY{o}{=}\PY{n}{HIDDEN\PYZus{}SIZE}\PY{p}{)}
            
            \PY{n}{projection\PYZus{}layer} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{n}{CH\PYZus{}VOCAB\PYZus{}SIZE}\PY{p}{,} \PY{n}{use\PYZus{}bias}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
            
            \PY{c+c1}{\PYZsh{} Helper }
            \PY{n}{helper} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{TrainingHelper}\PY{p}{(}\PY{n}{decoder\PYZus{}emb}\PY{p}{,} \PY{n}{decoder\PYZus{}lengths}\PY{p}{,} \PY{n}{time\PYZus{}major}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
            \PY{n}{init\PYZus{}state} \PY{o}{=} \PY{n}{decoder\PYZus{}cell}\PY{o}{.}\PY{n}{zero\PYZus{}state}\PY{p}{(}\PY{n}{BATCH\PYZus{}SIZE}\PY{p}{,} \PY{n}{tf}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{o}{.}\PY{n}{clone}\PY{p}{(}\PY{n}{cell\PYZus{}state}\PY{o}{=}\PY{n}{final\PYZus{}state}\PY{p}{)}
            \PY{n}{decoder} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{BasicDecoder}\PY{p}{(}\PY{n}{decoder\PYZus{}cell}\PY{p}{,} \PY{n}{helper}\PY{p}{,} \PY{n}{init\PYZus{}state}\PY{p}{,} \PY{n}{output\PYZus{}layer}\PY{o}{=}\PY{n}{projection\PYZus{}layer}\PY{p}{)}
            \PY{n}{outputs}\PY{p}{,} \PY{n}{final\PYZus{}state}\PY{p}{,} \PY{n}{final\PYZus{}sequence\PYZus{}lengths} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{dynamic\PYZus{}decode}\PY{p}{(}\PY{n}{decoder}\PY{p}{,} \PY{n}{output\PYZus{}time\PYZus{}major}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{swap\PYZus{}memory}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{p}{)}
            \PY{n}{logits} \PY{o}{=} \PY{n}{outputs}\PY{o}{.}\PY{n}{rnn\PYZus{}output}
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{logits}\PY{p}{)}
            \PY{n}{tgt\PYZus{}sos\PYZus{}id} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{cast}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{n}{tf}\PY{o}{.}\PY{n}{int32}\PY{p}{)}
            \PY{n}{tgt\PYZus{}eos\PYZus{}id} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{cast}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{tf}\PY{o}{.}\PY{n}{int32}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} Helper}
            \PY{n}{start\PYZus{}tokens} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{fill}\PY{p}{(}\PY{p}{[}\PY{n}{BATCH\PYZus{}SIZE}\PY{p}{]}\PY{p}{,} \PY{n}{tgt\PYZus{}sos\PYZus{}id}\PY{p}{)}
            \PY{n}{end\PYZus{}token} \PY{o}{=} \PY{n}{tgt\PYZus{}eos\PYZus{}id}
            \PY{c+c1}{\PYZsh{} Helper }
            \PY{n}{infer\PYZus{}helper} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{GreedyEmbeddingHelper}\PY{p}{(}\PY{n}{decoder\PYZus{}embedding}\PY{p}{,} \PY{n}{start\PYZus{}tokens}\PY{p}{,} \PY{n}{tgt\PYZus{}eos\PYZus{}id}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{infer\PYZus{}helper}\PY{p}{)}
            \PY{n}{infer\PYZus{}decoder} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{BasicDecoder}\PY{p}{(}\PY{n}{decoder\PYZus{}cell}\PY{p}{,} \PY{n}{infer\PYZus{}helper}\PY{p}{,} \PY{n}{init\PYZus{}state}\PY{p}{,} \PY{n}{output\PYZus{}layer}\PY{o}{=}\PY{n}{projection\PYZus{}layer}\PY{p}{)}
            \PY{n}{outputs}\PY{p}{,} \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{contrib}\PY{o}{.}\PY{n}{seq2seq}\PY{o}{.}\PY{n}{dynamic\PYZus{}decode}\PY{p}{(}\PY{n}{infer\PYZus{}decoder}\PY{p}{,} \PY{n}{maximum\PYZus{}iterations}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{)}
            \PY{n}{translations} \PY{o}{=} \PY{n}{outputs}\PY{o}{.}\PY{n}{sample\PYZus{}id}
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{translations}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Tensor("decoder\_cell/decoder/TensorArrayStack/TensorArrayGatherV3:0", shape=(?, 8, 151), dtype=float32)
<tensorflow.contrib.seq2seq.python.ops.helper.GreedyEmbeddingHelper object at 0x000001DC727E4E80>
Tensor("decoder\_cell/decoder\_1/transpose\_1:0", shape=(8, ?), dtype=int32)

    \end{Verbatim}

    \subsection{Optimizer}\label{optimizer}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{k}{with} \PY{n}{tf}\PY{o}{.}\PY{n}{variable\PYZus{}scope}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{optimizer}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{:}
             \PY{c+c1}{\PYZsh{} ======计算损失=======}
             \PY{n}{loss} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{nn}\PY{o}{.}\PY{n}{sparse\PYZus{}softmax\PYZus{}cross\PYZus{}entropy\PYZus{}with\PYZus{}logits}\PY{p}{(}\PY{n}{labels}\PY{o}{=}\PY{n}{decoder\PYZus{}targets}\PY{p}{,} \PY{n}{logits}\PY{o}{=}\PY{n}{logits}\PY{p}{)}
             \PY{n}{cost} \PY{o}{=} \PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(}\PY{p}{(}\PY{n}{loss} \PY{o}{*} \PY{n}{target\PYZus{}weights}\PY{p}{)} \PY{o}{/} \PY{n}{BATCH\PYZus{}SIZE}\PY{p}{)}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} =============优化算法==============}
             \PY{c+c1}{\PYZsh{} =============学习率衰减==============}
             \PY{n}{global\PYZus{}step} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{Variable}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}
             \PY{n}{learning\PYZus{}rate} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{train}\PY{o}{.}\PY{n}{exponential\PYZus{}decay}\PY{p}{(}\PY{n}{learning\PYZus{}rate}\PY{p}{,} \PY{n}{global\PYZus{}step}\PY{p}{,} \PY{n}{BATCH\PYZus{}NUMS}\PY{p}{,} \PY{l+m+mf}{0.99}\PY{p}{,} \PY{n}{staircase}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
                         \PY{c+c1}{\PYZsh{} =======通过clip\PYZus{}by\PYZus{}global\PYZus{}norm()控制梯度大小======}
             \PY{n}{trainable\PYZus{}variables} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{trainable\PYZus{}variables}\PY{p}{(}\PY{p}{)}
             \PY{n}{grads}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{clip\PYZus{}by\PYZus{}global\PYZus{}norm}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{gradients}\PY{p}{(}\PY{n}{cost}\PY{p}{,} \PY{n}{trainable\PYZus{}variables}\PY{p}{)}\PY{p}{,} \PY{n}{MAX\PYZus{}GRAD\PYZus{}NORM}\PY{p}{)}
             \PY{n}{opt} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{train}\PY{o}{.}\PY{n}{AdamOptimizer}\PY{p}{(}\PY{n}{learning\PYZus{}rate}\PY{p}{)}\PY{o}{.}\PY{n}{apply\PYZus{}gradients}\PY{p}{(}\PY{n+nb}{zip}\PY{p}{(}\PY{n}{grads}\PY{p}{,} \PY{n}{trainable\PYZus{}variables}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \subsection{train model}\label{train-model}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}11}]:} \PY{c+c1}{\PYZsh{} 保存模型}
         \PY{n}{saver} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{train}\PY{o}{.}\PY{n}{Saver}\PY{p}{(}\PY{p}{)}
         \PY{k}{with} \PY{n}{tf}\PY{o}{.}\PY{n}{Session}\PY{p}{(}\PY{p}{)} \PY{k}{as} \PY{n}{sess}\PY{p}{:}
         	\PY{n}{writer} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{summary}\PY{o}{.}\PY{n}{FileWriter}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{logs/tensorboard}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{tf}\PY{o}{.}\PY{n}{get\PYZus{}default\PYZus{}graph}\PY{p}{(}\PY{p}{)}\PY{p}{)}
         	\PY{n}{sess}\PY{o}{.}\PY{n}{run}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{global\PYZus{}variables\PYZus{}initializer}\PY{p}{(}\PY{p}{)}\PY{p}{)}
         	\PY{k}{for} \PY{n}{k} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{EPOCHS}\PY{p}{)}\PY{p}{:}
         		\PY{n}{total\PYZus{}loss} \PY{o}{=} \PY{l+m+mf}{0.}
         		\PY{n}{data\PYZus{}generator} \PY{o}{=} \PY{n}{batch\PYZus{}data}\PY{p}{(}\PY{n}{en\PYZus{}num\PYZus{}data}\PY{p}{,} \PY{n}{ch\PYZus{}num\PYZus{}data}\PY{p}{,} \PY{n}{de\PYZus{}num\PYZus{}data}\PY{p}{,} \PY{n}{BATCH\PYZus{}SIZE}\PY{p}{)}
         		\PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{BATCH\PYZus{}NUMS}\PY{p}{)}\PY{p}{:}
         			\PY{n}{en\PYZus{}input}\PY{p}{,} \PY{n}{de\PYZus{}input}\PY{p}{,} \PY{n}{de\PYZus{}tg}\PY{p}{,} \PY{n}{tg\PYZus{}weight}\PY{p}{,} \PY{n}{en\PYZus{}len}\PY{p}{,} \PY{n}{de\PYZus{}len} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{data\PYZus{}generator}\PY{p}{)}
         			\PY{n}{feed} \PY{o}{=} \PY{p}{\PYZob{}}\PY{n}{encoder\PYZus{}inputs}\PY{p}{:} \PY{n}{en\PYZus{}input}\PY{p}{,} \PY{n}{decoder\PYZus{}inputs}\PY{p}{:} \PY{n}{de\PYZus{}input}\PY{p}{,} \PY{n}{decoder\PYZus{}targets}\PY{p}{:} \PY{n}{de\PYZus{}tg}\PY{p}{,} \PY{n}{target\PYZus{}weights}\PY{p}{:} \PY{n}{tg\PYZus{}weight}\PY{p}{,} \PY{n}{source\PYZus{}sequence\PYZus{}length}\PY{p}{:} \PY{n}{en\PYZus{}len}\PY{p}{,} \PY{n}{decoder\PYZus{}lengths}\PY{p}{:} \PY{n}{de\PYZus{}len}\PY{p}{,} \PY{n}{keepprb}\PY{p}{:} \PY{l+m+mf}{0.8}\PY{p}{\PYZcb{}}
         			\PY{n}{costs}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{sess}\PY{o}{.}\PY{n}{run}\PY{p}{(}\PY{p}{[}\PY{n}{cost}\PY{p}{,} \PY{n}{opt}\PY{p}{]}\PY{p}{,} \PY{n}{feed\PYZus{}dict}\PY{o}{=}\PY{n}{feed}\PY{p}{)}
         			\PY{n}{total\PYZus{}loss} \PY{o}{+}\PY{o}{=} \PY{n}{costs}
         			\PY{k}{if} \PY{p}{(}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)} \PY{o}{\PYZpc{}} \PY{l+m+mi}{10} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
         				\PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{epochs:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{k} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{iter:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{i} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{cost:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{total\PYZus{}loss} \PY{o}{/} \PY{n}{i} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
         				\PY{c+c1}{\PYZsh{}print(\PYZsq{}predict:\PYZsq{}, sess.run(predict[0], feed\PYZus{}dict=feed))}
         				\PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{p}{[}\PY{n}{id2ch}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sess}\PY{o}{.}\PY{n}{run}\PY{p}{(}\PY{n}{predict}\PY{p}{,} \PY{n}{feed\PYZus{}dict}\PY{o}{=}\PY{n}{feed}\PY{p}{)}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         				\PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{label:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{p}{[}\PY{n}{id2ch}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{de\PYZus{}tg}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                         
         	\PY{n}{saver}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{n}{sess}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{./checkpoints/lstm.ckpt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{n}{writer}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
epochs: 1 iter: 10 cost: 28.16957155863444
text: <EOS><EOS><EOS><EOS><EOS><EOS><EOS><EOS><EOS><EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 2 iter: 10 cost: 23.598262363009983
text: 。。。。。。。<EOS>。。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 3 iter: 10 cost: 20.877000914679634
text: 。。。。<EOS><EOS><EOS><EOS><EOS><EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 4 iter: 10 cost: 20.28958871629503
text: 我。。。<EOS><EOS><EOS><EOS><EOS><EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 5 iter: 10 cost: 19.54624875386556
text: 我我。<EOS><EOS><EOS><EOS><EOS><EOS><EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 6 iter: 10 cost: 18.627729627821182
text: 我我。<EOS><EOS><EOS><EOS><EOS><EOS><EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 7 iter: 10 cost: 17.786174032423233
text: 我我。。<EOS><EOS>。<EOS><EOS><EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 8 iter: 10 cost: 16.798075675964355
text: 我我。。<EOS>。。。。。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 9 iter: 10 cost: 15.99839613172743
text: 我我。。<EOS>。。。。<EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 10 iter: 10 cost: 15.220106442769369
text: 我跑。。<EOS>。。。<EOS><EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 11 iter: 10 cost: 14.581268734402126
text: 他跑来。<EOS>。<EOS>。。。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 12 iter: 10 cost: 13.78583738538954
text: 他跑来。<EOS>。<EOS>。。。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 13 iter: 10 cost: 13.278606520758736
text: 他跑。。<EOS>。<EOS>。。<EOS>
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 14 iter: 10 cost: 12.672863748338488
text: 他我汤。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 15 iter: 10 cost: 11.928645822736952
text: 他跑来。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 16 iter: 10 cost: 11.013942930433485
text: 抓我汤。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 17 iter: 10 cost: 10.392344951629639
text: 往住汤。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 18 iter: 10 cost: 9.741677496168348
text: 他住汤。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 19 iter: 10 cost: 9.156592475043404
text: 他跑跑。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 20 iter: 10 cost: 8.507951630486382
text: 他住一。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 21 iter: 10 cost: 8.043408579296536
text: 他他他。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 22 iter: 10 cost: 7.495850616031223
text: 抓住一。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 23 iter: 10 cost: 7.089814742406209
text: 抓跑来。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 24 iter: 10 cost: 6.5663999981350365
text: 他住他。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 25 iter: 10 cost: 6.114324066374037
text: 抓住汤。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 26 iter: 10 cost: 5.678540468215942
text: 抓住汤。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 27 iter: 10 cost: 5.279112497965495
text: 他住他。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 28 iter: 10 cost: 4.983220948113336
text: 抓住。。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 29 iter: 10 cost: 4.652978817621866
text: 抓他他。<EOS>。<EOS>。吧吧
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 30 iter: 10 cost: 4.164341264300877
text: 抓住他。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 31 iter: 10 cost: 3.7733798027038574
text: 抓住他。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 32 iter: 10 cost: 3.6667114893595376
text: 他们。。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 33 iter: 10 cost: 3.4564550386534796
text: 抓住他。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 34 iter: 10 cost: 3.1476030482186212
text: 他住他。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 35 iter: 10 cost: 3.127575205432044
text: 抓住他。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 36 iter: 10 cost: 2.8649211525917053
text: 抓住他。<EOS>。吧。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 37 iter: 10 cost: 2.7529364890522428
text: 抓住他。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 38 iter: 10 cost: 2.577281935347451
text: 抓住他。<EOS>。<EOS>。儿。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 39 iter: 10 cost: 2.423507339424557
text: 抓住他。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 40 iter: 10 cost: 2.4241311285230847
text: 他住他。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 41 iter: 10 cost: 2.2313937511709003
text: 抓住他。<EOS>。吧。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 42 iter: 10 cost: 2.298823939429389
text: 抓住他。<EOS>。吧。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 43 iter: 10 cost: 2.0041200584835477
text: 抓住他。<EOS>。吧。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 44 iter: 10 cost: 2.016211552752389
text: 抓住他。<EOS>。吧。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 45 iter: 10 cost: 1.8909995837344065
text: 抓住他。<EOS>。吧。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 46 iter: 10 cost: 1.8611645359132025
text: 抓住他。<EOS>。吧。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 47 iter: 10 cost: 1.895936005645328
text: 抓住他。<EOS>。吧。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 48 iter: 10 cost: 1.8506290647718642
text: 抓住他。<EOS>。吧。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 49 iter: 10 cost: 1.7682217185695968
text: 抓住他。<EOS>。<EOS>。<EOS>。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>
epochs: 50 iter: 10 cost: 1.7869588716162577
text: 抓住他。<EOS>。<EOS>。吧。
label: 抓住他。<EOS><PAD><PAD><PAD><PAD><PAD>

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} 
\end{Verbatim}



    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
